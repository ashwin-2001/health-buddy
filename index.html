<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sehat Buddy ‚Äî Report Chat</title>
  <meta name="description" content="Mobile-first Hinglish health-report chatbot (Dark Mode) with auto model routing." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Dark mode palette (soft, low-contrast, iOS-like) */
      --bg:#0b0f16;
      --bg-2:#0f141d;
      --card:#121a24;
      --border:#1b2534;
      --text:#eef3ff;
      --muted:#9aa6bf;
      --accent:#0a84ff; /* iOS blue */
      --bubble-ai:#121a24;
      --bubble-user:#0f1b2c;
      --shadow:0 8px 22px rgba(0,0,0,0.28);
      --radius:18px;
      --radius-lg:22px;
    }
    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f5f7fb;
      --bg-2:#ffffff;
      --card:#ffffff;
      --border:#e6e9f2;
      --text:#0b1220;
      --muted:#6a7288;
      --accent:#0a84ff;
      --bubble-ai:#f6f8fc;
      --bubble-user:#eef5ff;
      --shadow:0 10px 20px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system, BlinkMacSystemFont, Inter, Segoe UI, Roboto, Arial, sans-serif; color:var(--text);
      background: linear-gradient(180deg, var(--bg), var(--bg-2));
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .app{min-height:100dvh; display:flex; flex-direction:column; max-width:720px; margin:0 auto}

    /* Minimal top bar */
    .top{position:sticky; top:0; z-index:20; backdrop-filter:saturate(180%) blur(18px); background:rgba(10,14,24,0.55); border-bottom:1px solid var(--border)}
    :root[data-theme="light"] .top{background:rgba(255,255,255,0.72);}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px}
    .brand-left{display:flex; align-items:center; gap:8px}
    .mark{width:28px; height:28px; border-radius:9px; background:linear-gradient(135deg,#0a84ff,#64d2ff); color:#fff; display:grid; place-items:center; font-weight:700}
    .title{font-size:15px; font-weight:700; letter-spacing:-0.01em}
    .sub{font-size:10.5px; color:var(--muted)}
      .brand-right{display:flex; align-items:center; gap:6px; flex-wrap:nowrap}
      .modeltag{max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:11px;color:var(--muted);border:1px solid var(--border);padding:4px 12px;border-radius:999px;background:rgba(255,255,255,0.04)}
      :root[data-theme="light"] .modeltag{background:rgba(0,0,0,0.03)}
      .iconbtn{width:28px; height:28px; display:grid; place-items:center; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer}
      .iconbtn:active{transform:scale(0.97)}

    @media (max-width: 420px){
      .brand{flex-direction:column; align-items:flex-start; gap:6px}
      .brand-right{width:100%; flex-wrap:wrap}
      .modeltag{flex:1 1 100%; order:0}
      .iconbtn{order:1}
    }

      /* Thinking chip */
      .thinking{display:inline-flex; align-items:center; gap:8px; max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:11px; color:var(--muted); border:1px solid var(--border); padding:4px 10px; border-radius:999px; background:rgba(255,255,255,0.04)}
      .thinking .spin{width:14px; height:14px; border:2px solid var(--muted); border-top-color:transparent; border-radius:50%; display:inline-block; animation:sbspin .9s linear infinite}
      @keyframes sbspin{to{transform:rotate(360deg)}}

    /* Chat */
    .chat{flex:1; padding:8px 10px; display:flex; flex-direction:column; gap:8px; overflow:auto; scroll-behavior:smooth}
    @media (max-width:420px){ .chat{padding:6px 8px; gap:6px} }
    .bubble{max-width:90%; padding:10px 12px; border-radius:16px; border:1px solid transparent; box-shadow:none; white-space:pre-wrap; line-height:1.5; font-size:15px; -webkit-font-smoothing:antialiased}
    @media (max-width:420px){ .bubble{font-size:14px; border-radius:14px; padding:9px 11px} }
    .from-user{align-self:flex-end; background:var(--bubble-user);}
    .from-ai{align-self:flex-start; background:var(--bubble-ai);}

    /* Uploader ‚Äî single big tile */
    .uploader{padding:8px 12px}
    #uploadTile{display:grid; place-items:center; width:100%; height:148px; border:1px dashed var(--border); border-radius:var(--radius-lg); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05)); cursor:pointer; user-select:none}
    :root[data-theme="light"] #uploadTile{background:linear-gradient(180deg,#ffffff,#f8faff)}
    #uploadTile:active{transform:scale(0.997)}
    .plus{display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--muted)}
    .plus-icon{width:48px; height:48px; border-radius:14px; display:grid; place-items:center; background:#0f1722; border:1px solid var(--border)}
    :root[data-theme="light"] .plus-icon{background:#f4f7ff}
    .plus-icon svg{width:24px; height:24px; color:#b8c6ff}
    :root[data-theme="light"] .plus-icon svg{color:#6580ff}
    .plus-label{font-size:14px}
    .thumbWrap{width:100%; height:100%; overflow:hidden; border-radius:inherit}
    .thumbWrap img{width:100%; height:100%; object-fit:cover}

    /* Composer */
    .composer{position:sticky; bottom:0; z-index:50; padding:6px 10px calc(12px + env(safe-area-inset-bottom)); background:linear-gradient(180deg, rgba(11,18,32,0), rgba(11,18,32,0.75) 30%, #0b1220)}
    :root[data-theme="light"] .composer{background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,0.78) 30%, #ffffff)}
    .field{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end; border:1px solid var(--border); border-radius:18px; padding:8px 10px; background:var(--card); -webkit-backdrop-filter:saturate(180%) blur(10px); backdrop-filter:saturate(180%) blur(10px)}
    :root[data-theme="light"] .field{background:rgba(255,255,255,0.86)}
    textarea{resize:none; min-height:52px; max-height:40vh; border:none; outline:none; font-size:15px; padding:6px 6px; width:100%; background:transparent; color:var(--text); -webkit-tap-highlight-color: transparent}
    textarea::placeholder{color:#94a3b8}
    :root[data-theme="light"] textarea::placeholder{color:#8a93a6}
    .send{appearance:none; border:none; outline:none; border-radius:999px; width:42px; height:42px; display:grid; place-items:center; font-weight:700; cursor:pointer; background:#0a84ff; color:white; box-shadow:0 8px 20px rgba(10,132,255,0.22)}
    .send:disabled{opacity:.6}

    /* Hint */
    .hint{font-size:12px; color:var(--muted); padding:0 16px 10px; max-height:120px; overflow:hidden; transition:max-height .28s ease, opacity .18s ease, padding .28s ease}
    .hint.collapsed{max-height:0; opacity:0; padding:0 16px 0}

      /* Suggestions Overlay (glass, full screen) */
      .suggOverlay{position:fixed; inset:0; z-index:60; display:none; pointer-events:none; background:transparent}
      :root[data-theme="light"] .suggOverlay{background:transparent}
      .suggOverlay.show{display:block}
      .suggSheet{position:fixed; left:12px; right:12px; bottom:88px; display:flex; flex-direction:column; gap:10px; pointer-events:auto;
        padding:12px; border-radius:18px; border:1px solid var(--border);
        background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
        -webkit-backdrop-filter:saturate(180%) blur(16px); backdrop-filter:saturate(180%) blur(16px);
        box-shadow:0 18px 36px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.10);
        transform: translateY(8px); opacity:0; transition: transform .18s ease, opacity .18s ease;
      }
      .suggOverlay.show .suggSheet{transform:translateY(0); opacity:1}
      /* Suggestions slider has no header/boundary; just list items over the frosted sheet */
      .suggHeader{display:none}
      .suggList{max-height:38vh; overflow:auto; display:flex; flex-direction:column; gap:8px}
      .suggestions{all:unset; display:block}
      .sugg{width:100%; text-align:left; font-size:15px; color:var(--text); background:transparent; border:none; padding:8px 6px; border-radius:10px; cursor:pointer}
      :root[data-theme="light"] .sugg{background:transparent}
      .sugg:active{transform:scale(0.995)}
      .sugg-label{all:unset}

      /* Light mode background refinement */
      :root[data-theme="light"] body{
        background: linear-gradient(180deg, var(--bg), var(--bg-2));
      }

      /* Focus styles for accessibility */
      .iconbtn:focus-visible, .sugg:focus-visible, #uploadTile:focus-visible, .send:focus-visible{
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

    @media (min-width:768px){
      #uploadTile{height:200px}
      textarea{min-height:72px}
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <div class="top">
      <div class="brand">
        <div class="brand-left">
          <div class="mark" aria-hidden="true">SB</div>
          <div>
            <div class="title">Sehat Buddy</div>
            <div class="sub">Hinglish report chat ‚Ä¢ ‚ö†Ô∏è Emergency ho to turant doctor/ER</div>
          </div>
        </div>
        <div class="brand-right">
          <div class="modeltag" id="modelTag" title="Auto model selection">gpt‚Äë5‚Äëmini ‚Ä¢ effort: medium (auto)</div>
          <button class="iconbtn" id="newChatBtn" title="New chat" aria-label="New chat">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16M4 12h10M4 17h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button class="iconbtn" id="themeBtn" title="Toggle theme" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v2m0 14v2m7-9h2M3 12H1m14.95-6.95 1.41-1.41M6.64 17.36l-1.41 1.41m0-12.72L6.64 7.05M17.36 17.36l1.41 1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </div>

    <main class="chat" id="chat" aria-live="polite"></main>

    <div class="uploader">
      <div id="uploadTile" tabindex="0" role="button" aria-label="Tasveer jodo (ek hi image)">
        <div class="plus" id="plusState">
          <div class="plus-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
          <div class="plus-label">Tasveer jodo (jpg/png)</div>
        </div>
        <div class="thumbWrap" id="thumbWrap" hidden></div>
        <input type="file" id="file" accept="image/*" hidden />
      </div>
      <div class="hint">Sirf **ek** image add hogi. Zarurat ho to nayi image add karke purani replace ho jayegi.</div>
    </div>

    <div class="suggOverlay" id="suggOverlay" role="dialog" aria-modal="true" hidden>
      <div class="suggSheet">
        <div class="suggHeader">
          <div class="suggTitle" id="suggLabel">Smart suggestions</div>
          <button class="suggClose" id="suggClose" aria-label="Close suggestions">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
        <div class="suggList suggestions" id="suggestions"></div>
      </div>
    </div>

    <div class="composer">
      <div class="field">
        <textarea id="userInput" placeholder="Yahan likhiye‚Ä¶ (jaise: ‚ÄòYeh CBC report samjha do‚Äô)"></textarea>
        <button class="send" id="sendBtn" aria-label="Bhejo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="m4 12 7-7m-7 7 7 7m9-7H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="hint" id="privacyHint">Privacy: Yahan hum data store nahi karte. Par jawab ke liye OpenAI ko bhejna padta hai. Personal details share na karein. Yeh general info hai; final salah ke liye apne doctor se milen.</div>
    </div>
  </div>

  <script>
    // ====== Theme bootstrap before UI paints ======
    (function(){
      const saved = localStorage.getItem('sb_theme');
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      const mode = saved || (prefersLight ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', mode);
    })();

    // ====== Config: API key via base64url-encoded string (avoids plaintext in source) ======
    const ENCODED_KEY = 'c2stcHJvai00VTVtbW53VzdvSE85cVkwd29zd3c5dFJaYlRHRkttVFR1SFlWYmVoSTZKYTR5NXk0MEM4MS11Sk90bWphQmtfMWxSZnQ4Umw2SlQzQmxia0ZKd1o3RzEyVTM2Njl1UGlqUVZFanhQYVJUaVNwSlFUVTVlV2RjdWF2RDV4eUJzcTdhZXJydTJ0SnJ0RHZBTXlXWldrM3RKUEpZb0E=';
    function decodeBase64Url(encoded){
      try{
        const b64 = encoded.replace(/-/g,'+').replace(/_/g,'/').replace(/\s/g,'');
        const padLen = (4 - (b64.length % 4)) % 4;
        const b64p = b64 + '='.repeat(padLen);
        return atob(b64p);
      }catch{ return ''; }
    }
    let API_KEY = decodeBase64Url(ENCODED_KEY);

    // ====== Minimal Apple-like experience, all visible text in Hinglish ======
    const chat = document.getElementById('chat');
    const sendBtn = document.getElementById('sendBtn');
    const input = document.getElementById('userInput');
    const fileInput = document.getElementById('file');
    const uploadTile = document.getElementById('uploadTile');
    const plusState = document.getElementById('plusState');
    const thumbWrap = document.getElementById('thumbWrap');
    const modelTag = document.getElementById('modelTag');
    const themeBtn = document.getElementById('themeBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const suggestionsEl = document.getElementById('suggestions');
    const suggLabelEl = document.getElementById('suggLabel');
    const suggOverlayEl = document.getElementById('suggOverlay');
    const suggCloseBtn = document.getElementById('suggClose');
    const suggSheetEl = document.querySelector('.suggSheet');
    const composerFieldEl = document.querySelector('.composer .field');
    const thinkingTag = document.getElementById('thinkingTag');
    const privacyHint = document.getElementById('privacyHint');

    const SYSTEM_PROMPT = `Tum *Sehat Buddy* ho ‚Äî ek warm, professional female health guide (nurse-style) jo Indian families ko simple Hinglish me samjhati hai.\n\nSMART RESPONSE POLICY:\n- Pehle intent samjho; uske hisaab se sirf relevant cheezein likho. Template kabhi force mat karo.\n- Tone: gentle, practical, confident; thodi si emotions ok (\"main saath hoonüíô\"), par over-cute nahi.\n- Style: short lines, crisp bullets; 90‚Äì160 words typical.\n- Emojis/quotes: zarurat ho tab 1‚Äì3 max; bina context mat daalo.\n- Safety: \u26a0\ufe0f Diagnosis/medicine prescribe nahi. Red flags dikhe to clear warning + action.\n- Missing info ho to ant me 1‚Äì2 follow‚Äëup sawaal hi poochho (inline).\n- Agar sirf hello/thanks ho to ultra‚Äëbrief response.\n- Image aayi to OCR-soch se sirf jo dikh raha hai wohi batana; unreadable ho to politely better photo maangna.\n\nHOW TO ANSWER (adaptive):\n- Reports: 1‚Äì2 line summary ‚ûú 3‚Äì5 key points (result vs range, simple meaning) ‚ûú \"What to watch\" ‚ûú Next steps.\n- Medicines: kya hai, kyun diya jata, common vs serious side‚Äëeffects (red‚Äëflag), generic how‚Äëto.\n- Symptom/monitoring requests (jaise temperature note): chhota checklist + when to worry; template sirf tab dena jab user explicitly bole \"template\"/\"format\".\n- Kabhi bhi khokla section (e.g., \"Image-specific points: N/A\") mat likho.\n- Ek final line me disclaimer do: \"Yeh general info hai; apne doctor se confirm karein.\"\n\nOUTPUT (JSON only):\nReturn ek single JSON object: {\n  \"reply\": string (Hinglish, female voice, concise, adaptive),\n  \"suggestions\": string[2] (8‚Äì12 words, patient-style prompts, safe)\n}. JSON ke bahar kuch nahi.`;

    let currentImageDataUrl = null; // data URL for single image
    const history = [];

    // Welcome
    addBubble('Namaste! üëã Apna report photo ya text bhejiye. Main simple Hinglish mein samjhaunga/samjhaungi. (\u26a0\ufe0f Emergency mein turant doctor/ER.)', 'ai');

    // Upload interactions ‚Äî single image
    uploadTile.addEventListener('click', ()=> fileInput.click());
    uploadTile.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); } });
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return; if(!f.type.startsWith('image/')){ alert('Image hi choose karein (jpg/png).'); return; }
      const dataUrl = await fileToDataURL(f);
      const resized = await resizeImageDataURL(dataUrl, 1600, 1600, 0.9);
      currentImageDataUrl = resized || dataUrl;
      renderThumb(currentImageDataUrl);
    });

    function renderThumb(dataUrl){
      plusState.hidden = true; thumbWrap.hidden = false; thumbWrap.innerHTML = `<img alt="aapki image" src="${dataUrl}"/>`;
    }

    // Send actions
    sendBtn.addEventListener('click', onSend);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSend(); } });

    // Theme toggle
    themeBtn.addEventListener('click', ()=>{
      const curr = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = curr === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('sb_theme', next);
    });

    // New chat
    newChatBtn.addEventListener('click', ()=>{
      clearChatAndState();
      generateInitialSuggestions();
    });

    // Suggestion click (event delegation)
    suggestionsEl.addEventListener('click', (e)=>{
      const target = e.target.closest('[data-suggestion]');
      if(!target) return;
      input.value = target.getAttribute('data-suggestion') || '';
      closeSuggestionsOverlay();
      onSend();
    });

    // Open suggestions on input focus (overlay sits behind composer so typing still possible)
    input.addEventListener('focus', ()=>{ openSuggestionsOverlay(); positionSuggestionsOverlay(); });
    // Close when clicking anywhere
    document.addEventListener('click', (e)=>{
      const within = e.target.closest('.suggSheet') || e.target.closest('#userInput');
      if(!within) closeSuggestionsOverlay();
    });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSuggestionsOverlay(); });
    window.addEventListener('resize', positionSuggestionsOverlay);
    window.addEventListener('orientationchange', positionSuggestionsOverlay);

    function positionSuggestionsOverlay(){
      if(!composerFieldEl || !suggSheetEl) return;
      const rect = composerFieldEl.getBoundingClientRect();
      const bottom = Math.max(window.innerHeight - Math.round(rect.top) + 6, 0); // lift a little above
      suggSheetEl.style.bottom = `${bottom}px`;
    }

    function openSuggestionsOverlay(){
      suggOverlayEl.hidden = false;
      suggOverlayEl.classList.add('show');
      // Keep body scroll to allow chat context while overlay is open; composer is above overlay
    }
    function closeSuggestionsOverlay(){
      suggOverlayEl.classList.remove('show');
      suggOverlayEl.hidden = true;
      // restore if we had changed any global scroll (we didn't)
    }

    let requestInFlight = false;
    async function onSend(){
      if(requestInFlight) return; // avoid duplicate sends
      const text = input.value.trim();
      if(!text && !currentImageDataUrl){ alert('Kuch likhiye ya image add kijiye.'); return; }

      // Immediately lock UI for current request
      requestInFlight = true;
      sendBtn.disabled = true;
      sendBtn.setAttribute('aria-disabled','true');
      closeSuggestionsOverlay();

      if(history.length === 0){ history.push({ role:'system', content:[{type:'input_text', text: SYSTEM_PROMPT}] }); }

      addBubble(text || '[Sirf image]', 'user', currentImageDataUrl);

      const hasImage = !!currentImageDataUrl;
      const route = await routeDecision(text, hasImage).catch(()=> fallbackHeuristic(text, hasImage));
      updateModelTag(route.model, route.effort);

      const userContent = [];
      if(text) userContent.push({ type:'input_text', text });
      if(currentImageDataUrl) userContent.push({ type:'input_image', image_url: currentImageDataUrl });
      history.push({ role:'user', content: userContent });

      input.value = '';
      currentImageDataUrl = null; plusState.hidden = false; thumbWrap.hidden = true; thumbWrap.innerHTML='';

      // Collapse privacy hint after the first outgoing request
      if(privacyHint && !privacyHint.classList.contains('collapsed')){
        privacyHint.classList.add('collapsed');
      }

      const aiBubble = addBubble('...', 'ai');
      startDots(aiBubble);
      try{
        const responseText = await streamToBubble({
          model: route.model,
          input: history,
          reasoning: { effort: route.effort },
          text: { verbosity: route.effort==='high' ? 'high' : 'medium' },
          stream: true,
          store: false
        }, API_KEY, aiBubble);
      }catch(err){
        console.error(err);
        aiBubble.innerHTML = `<b style="color:#ff6b6b">Error:</b> ${escapeHtml(err.message||err)}`;
      }finally{ sendBtn.disabled = false; sendBtn.removeAttribute('aria-disabled'); requestInFlight = false; stopDots(aiBubble); }
    }

    function updateModelTag(model, effort){
      const effortWord = effort === 'high' ? 'deep' : effort === 'medium' ? 'balanced' : 'light';
      const name = model.replace(/-/g,'‚Äë'); // use non-breaking hyphen for nicer chip
      modelTag.textContent = `${name} ‚Ä¢ ${effortWord} reasoning`;
    }

    let dotsTimer = null;
    function startDots(bubbleEl){
      stopDots();
      if(!(bubbleEl && bubbleEl.classList.contains('from-ai'))) return;
      const frames = ['...', '.... ....', '...', '..'];
      let i = 0;
      bubbleEl.textContent = frames[0];
      dotsTimer = setInterval(()=>{
        i = (i + 1) % frames.length;
        bubbleEl.textContent = frames[i];
      }, 300);
    }
    function stopDots(){ if(dotsTimer){ clearInterval(dotsTimer); dotsTimer = null; } }

    // Auto model routing using gpt-5-mini (with safe fallback)
    async function routeDecision(text, hasImage){
      if(hasImage) return { model: 'gpt-5', effort: 'high' };
      const routerSystem = 'Aap ek router ho. Sirf JSON return karo jisme `model` ("gpt-5" ya "gpt-5-mini") aur `effort` ("low"|"medium"|"high") ho. Rule: agar kaam chota/hello/thanks jaisa hai to gpt-5-mini, effort low. Agar medical report/zyada detail/analysis chahiye to gpt-5, effort high. Beech me ho to gpt-5-mini, effort medium. Sirf JSON, aur kuch nahi.';
      const promptText = JSON.stringify({ text: (text||'').slice(0,2000), chars: (text||'').length, hasImage }, null, 2);
      const payload = {
        model: 'gpt-5-mini',
        input: [
          { role: 'system', content: [{ type:'input_text', text: routerSystem }]},
          { role: 'user', content: [{ type:'input_text', text: promptText }]}
        ],
        text: { verbosity: 'low' },
        stream: true,
        store: false
      };
      const txt = await readSSEText(payload, API_KEY);
      const match = txt.match(/\{[\s\S]*\}/);
      if(match){
        try{
          const obj = JSON.parse(match[0]);
          if((obj.model==='gpt-5'||obj.model==='gpt-5-mini') && (obj.effort==='low'||obj.effort==='medium'||obj.effort==='high')) return obj;
        }catch{}
      }
      return fallbackHeuristic(text, hasImage);
    }

    function fallbackHeuristic(text, hasImage){
      if(hasImage) return { model:'gpt-5', effort:'high' };
      const t = (text||'').toLowerCase();
      const len = t.length;
      const nums = (t.match(/\d+/g)||[]).length;
      const keywords = /(report|cbc|wbc|rbc|hb|hba1c|lipid|ldl|hdl|triglyceride|x-ray|xray|ecg|mri|ct|biopsy|scan|interpret|analysis|explain|reference|range|mg\/dl|mmol|mm\^3|platelet|bilirubin|creatinine|bun|sgot|sgpt)/i.test(t);
      if(keywords || len>240 || nums>=3) return { model:'gpt-5', effort:'high' };
      if(len<20) return { model:'gpt-5-mini', effort:'low' };
      return { model:'gpt-5-mini', effort:'medium' };
    }

    // Read Responses API stream and return plain text (no UI updates)
    async function readSSEText(payload, apiKey){
      const res = await fetch('https://api.openai.com/v1/responses', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` }, body: JSON.stringify(payload) });
      if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
      const reader = res.body.getReader(); const decoder = new TextDecoder('utf-8'); let fullText=''; let buf='';
      while(true){ const {done, value} = await reader.read(); if(done) break; buf += decoder.decode(value, {stream:true}); const parts = buf.split(/\r?\n/); buf = parts.pop() ?? ''; for(const l of parts){ if(!l.startsWith('data: ')) continue; const d=l.slice(6).trim(); if(d==='[DONE]') continue; try{ const e=JSON.parse(d); if(e.type==='response.output_text.delta' && typeof e.delta==='string'){ fullText+=e.delta; } else if(typeof e.output_text==='string'){ fullText+=e.output_text; } }catch{} } }
      return fullText;
    }

    // Chat bubble helper
    function addBubble(text, who='ai', imgUrl=null){
      const el = document.createElement('div');
      el.className = 'bubble ' + (who==='user' ? 'from-user' : 'from-ai');
      if(imgUrl){
        el.innerHTML = `${text ? escapeHtml(text) + '<br/>' : ''}<div style="margin-top:10px; border:1px solid var(--border); border-radius:16px; overflow:hidden; max-height:320px"><img alt="aapki image" src="${imgUrl}" style="display:block; width:100%; height:auto"/></div>`;
      } else {
        el.textContent = text;
      }
      chat.appendChild(el); chat.scrollTop = chat.scrollHeight; return el;
    }

    // Streaming to bubble via Responses API (robust SSE parsing with buffering)
    async function streamToBubble(payload, apiKey, bubbleEl){
      const res = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let fullText = '';
      let sseBuffer = '';
      const isJsonFormat = false; // text-only streaming; JSON shaped via prompt examples

      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        sseBuffer += decoder.decode(value, {stream:true});
        const parts = sseBuffer.split(/\r?\n/);
        sseBuffer = parts.pop() ?? '';

        for(const line of parts){
          if(!line) continue;
          if(!line.startsWith('data: ')) continue;
          const data = line.slice(6).trim();
          if(data === '[DONE]') continue;
          try{
            const evt = JSON.parse(data);
            if(evt.type === 'response.output_text.delta' && typeof evt.delta === 'string'){
              fullText += evt.delta;
            } else if(evt.type === 'message.delta' && evt.delta?.content?.length){
              const piece = evt.delta.content.map(p=>p.text || '').join('');
              fullText += piece;
            } else if(typeof evt.output_text === 'string'){
              fullText += evt.output_text;
            }
            if(isJsonFormat){
              const prog = extractReplyProgressive(fullText);
              if(prog && typeof prog.text === 'string'){
                bubbleEl.textContent = prog.text; chat.scrollTop = chat.scrollHeight;
              }
            } else {
              bubbleEl.textContent = fullText; chat.scrollTop = chat.scrollHeight;
            }
          }catch(e){ /* Agar JSON half aya ho to next chunk me complete hoga */ }
        }
      }
      let displayText = fullText;
      // Try to parse final JSON object from text to also pick suggestions
      let obj = null;
      try{ obj = JSON.parse(fullText); }
      catch{
        const match = fullText.match(/\{[\s\S]*\}/);
        if(match){ try{ obj = JSON.parse(match[0]); }catch{} }
      }
      if(obj && (typeof obj.reply === 'string' || typeof obj.answer === 'string' || typeof obj.text === 'string')){
        displayText = obj.reply || obj.answer || obj.text;
        if(Array.isArray(obj.suggestions) && obj.suggestions.length){
          renderSuggestions(obj.suggestions.slice(0,4), true);
        }
        bubbleEl.textContent = displayText;
      }

      history.push({ role:'assistant', content:[{type:'output_text', text: displayText}] });
      return displayText;
    }

    // Utilities
    function fileToDataURL(file){
      return new Promise((resolve, reject)=>{ const r = new FileReader(); r.onload = ()=>resolve(r.result); r.onerror = reject; r.readAsDataURL(file); });
    }
    function resizeImageDataURL(src, maxW=1600, maxH=1600, quality=0.9){
      return new Promise((resolve)=>{ const img = new Image(); img.onload = ()=>{ let w=img.width, h=img.height; const ratio = Math.min(maxW/w, maxH/h, 1); const cw=Math.round(w*ratio), ch=Math.round(h*ratio); const c=document.createElement('canvas'); c.width=cw; c.height=ch; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch); const type = src.startsWith('data:image/png')? 'image/png':'image/jpeg'; resolve(c.toDataURL(type, quality)); }; img.onerror=()=>resolve(null); img.src=src; });
    }
    function escapeHtml(str){ return (str||'').replace(/[&<>\"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[s]); }

    function clearChatAndState(){
      chat.innerHTML = '';
      history.length = 0;
      currentImageDataUrl = null;
      plusState.hidden = false; thumbWrap.hidden = true; thumbWrap.innerHTML='';
      addBubble('Namaste! üëã Apna report photo ya text bhejiye. Main simple Hinglish mein samjhaunga/samjhaungi. (‚ö†Ô∏è Emergency mein turant doctor/ER.)', 'ai');
      updateModelTag('gpt-5-mini','medium');
      renderSuggestions([], false);
    }

    // Attempt to progressively extract JSON.reply text as it streams
    function extractReplyProgressive(buffer){
      // Find last opening brace to reduce likelihood of parsing half JSON arrays at start
      const idx = buffer.lastIndexOf('{');
      if(idx === -1) return null;
      const candidate = buffer.slice(idx);
      // Try strict parse first
      try{ const o = JSON.parse(candidate); return { text: o.reply || o.answer || o.text || '' }; }catch{}
      // Fallback: try to find a partial reply value: "reply":" ... 
      const m = candidate.match(/"(reply|answer|text)"\s*:\s*"([\s\S]*?)"\s*(,|\})/);
      if(m){
        // Unescape common JSON escapes progressively
        try{ return { text: JSON.parse('"'+m[2].replace(/\\(?!["\\\/bfnrtu])/g,'\\\\')+'"') }; }catch{}
        return { text: m[2].replace(/\\n/g,'\n').replace(/\\t/g,'\t').replace(/\\"/g,'"') };
      }
      return null;
    }

    // ====== Suggestions ======
    function renderSuggestions(items, showLabel=true){
      suggestionsEl.innerHTML = '';
      if(items && items.length){
        const two = items.slice(0,2);
        suggLabelEl.hidden = !showLabel;
        for(const s of two){
          const btn = document.createElement('button');
          btn.className = 'sugg';
          btn.type = 'button';
          btn.setAttribute('data-suggestion', s);
          btn.textContent = s;
          suggestionsEl.appendChild(btn);
        }
      } else {
        suggLabelEl.hidden = true;
      }
    }

    async function callJSONResponse(payload, apiKey){
      const res = await fetch('https://api.openai.com/v1/responses', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
      const data = await res.json();
      let txt = '';
      if(typeof data.output_text === 'string') txt = data.output_text;
      else if(Array.isArray(data.output)){
        // Fallback to concatenating any text parts
        try{ txt = data.output.map(o=> (o?.content||[]).map(c=>c.text||'').join('')).join(''); }catch{ txt=''; }
      }
      return txt;
    }

    function defaultStarterSuggestions(){
      return [
        'CBC report simple words me samjha do',
        'Lipid profile me LDL high ka matlab kya?'
      ];
    }

    async function generateInitialSuggestions(){
      try{
        const sys = 'Return only JSON with key `suggestions` as array of 2 short Hinglish user prompts for Sehat Buddy (patient-assistant style). They must read like what the user would type to the chatbot, not questions to the patient. Keep 8‚Äì12 words each, Indian mom friendly, general and safe. Only valid JSON.';
        const payload = {
          model: 'gpt-5-mini',
          input: [
            { role: 'system', content: [{ type:'input_text', text: sys }] }
          ],
          reasoning: { effort: 'low' },
          text: { format: { type: 'json_object' }, verbosity: 'low' },
          stream: false,
          store: false
        };
        const txt = await callJSONResponse(payload, API_KEY);
        const obj = JSON.parse(txt);
         const items = Array.isArray(obj?.suggestions) ? obj.suggestions.slice(0,2) : defaultStarterSuggestions().slice(0,2);
        renderSuggestions(items, true);
      }catch{
        renderSuggestions(defaultStarterSuggestions().slice(0,2), true);
      }
    }

    async function generateFollowupSuggestions(lastAssistantText){
      try{
        const sys = 'Return only JSON with key `suggestions` as array of 2 short Hinglish user prompts to continue the chat with Sehat Buddy (patient-assistant style). They must be phrased as what the user should ask next, not clinician-to-patient questions. Keep 8‚Äì12 words, relevant to the assistant reply below. Only valid JSON.';
        const payload = {
          model: 'gpt-5-mini',
          input: [
            { role: 'system', content: [{ type:'input_text', text: sys }] },
            { role: 'user', content: [{ type:'input_text', text: (lastAssistantText||'').slice(0,1200) }] }
          ],
          text: { format: { type: 'json_object' }, verbosity: 'low' },
          stream: false,
          store: false
        };
        const txt = await callJSONResponse(payload, API_KEY);
        const obj = JSON.parse(txt);
         const items = Array.isArray(obj?.suggestions) ? obj.suggestions.slice(0,2) : [];
        if(items.length){ renderSuggestions(items, true); }
      }catch{
        // Keep previous suggestions if follow-up generation fails
      }
    }

    // ====== Lightweight hidden tests (console me) ======
    function runTests(){
      const results = [];
      const assert = (ok, name)=>{ (ok?console.log:console.error)(ok?`‚úÖ ${name}`:`‚ùå ${name}`); results.push({name, ok}); };

      // Test 1: Regex split for CRLF/LF
      const t1 = 'data: x\n' + 'data: y\r\n' + 'data: z\n';
      const lines1 = t1.split(/\r?\n/).filter(Boolean);
      assert(lines1.length === 3 && lines1[0]==='data: x' && lines1[2]==='data: z', 'Split works for LF & CRLF');

      // Test 2: SSE buffering across chunks for response.output_text.delta
      let buf=''; let collected='';
      function feed(chunk){
        buf += chunk; const parts = buf.split(/\r?\n/); buf = parts.pop() ?? ''; for(const l of parts){ if(l.startsWith('data: ')){ const d=l.slice(6); try{const e=JSON.parse(d); if(e.type==='response.output_text.delta') collected+=e.delta;}catch{ /* ignore */ } } }
      }
      feed('data: {"type":"response.output_text.delta","delta":"He"}\n');
      feed('data: {"type":"response.output_text.delta","delta":"llo"}\n');
      feed('data: [DONE]\n');
      assert(collected==='Hello', 'Buffer handles split events');

      // Test 3: message.delta fallback
      buf=''; collected='';
      function feed2(chunk){ buf += chunk; const parts = buf.split(/\r?\n/); buf = parts.pop() ?? ''; for(const l of parts){ if(l.startsWith('data: ')){ const d=l.slice(6); try{const e=JSON.parse(d); if(e.type==='message.delta' && e.delta?.content?.length){ collected += e.delta.content.map(p=>p.text||'').join(''); }}catch{} } } }
      feed2('data: {"type":"message.delta","delta":{"content":[{"type":"output_text","text":"Hi"}]}}\n');
      feed2('data: {"type":"message.delta","delta":{"content":[{"type":"output_text","text":"!"}]}}\n');
      assert(collected==='Hi!', 'Fallback handles message.delta');

      // Test 4: heuristic ‚Äî greeting -> mini/low
      const h1 = fallbackHeuristic('hi', false);
      assert(h1.model==='gpt-5-mini' && h1.effort==='low', 'Heuristic: greeting uses mini/low');

      // Test 5: heuristic ‚Äî long medical -> gpt-5/high
      const medicalText = 'Please explain my lipid profile: LDL 165 mg/dL, HDL 38 mg/dL, Triglycerides 260 mg/dL, total cholesterol 260 mg/dL, reference ranges, reasons, lifestyle.';
      const h2 = fallbackHeuristic(medicalText, false);
      assert(h2.model==='gpt-5' && h2.effort==='high', 'Heuristic: medical analysis uses gpt-5/high');

      // Test 6: heuristic ‚Äî image present -> gpt-5/high
      const h3 = fallbackHeuristic('anything', true);
      assert(h3.model==='gpt-5' && h3.effort==='high', 'Heuristic: image => gpt-5/high');

      const allOk = results.every(r=>r.ok);
      console.log(allOk? '‚úÖ All tests passed' : '‚ùå Some tests failed');
    }
    window.addEventListener('load', runTests);
    window.addEventListener('load', generateInitialSuggestions);
  </script>
</body>
</html>
