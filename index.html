<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sehat Buddy — Report Chat (Dark)</title>
  <meta name="description" content="Mobile-first Hinglish health-report chatbot (Dark Mode) with auto model routing." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Dark iOS-inspired palette */
      --bg:#0b1220;
      --bg-2:#0e1426;
      --card:#0d1324;
      --border:#1b2540;
      --text:#e6ebff;
      --muted:#9aa4c7;
      --accent:#0a84ff; /* iOS blue */
      --bubble-ai:#0f1b34;
      --bubble-user:#14203b;
      --shadow:0 14px 40px rgba(0,0,0,0.35);
      --radius:22px;
      --radius-lg:28px;
    }
    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f5f7fb;
      --bg-2:#ffffff;
      --card:#ffffff;
      --border:#d7dcee;
      --text:#0b1220;
      --muted:#5b678a;
      --accent:#0a84ff;
      --bubble-ai:#f1f4fb;
      --bubble-user:#e9f2ff;
      --shadow:0 8px 28px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system, BlinkMacSystemFont, Inter, Segoe UI, Roboto, Arial, sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 80% -200px, rgba(40,70,160,0.25), transparent),
        radial-gradient(900px 700px at -10% -150px, rgba(20,140,255,0.18), transparent),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .app{min-height:100dvh; display:flex; flex-direction:column; max-width:800px; margin:0 auto}

    /* Minimal top bar */
    .top{position:sticky; top:0; z-index:20; backdrop-filter:saturate(180%) blur(12px); background:rgba(10,14,24,0.6); border-bottom:1px solid var(--border)}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px}
    .brand-left{display:flex; align-items:center; gap:12px}
    .mark{width:36px; height:36px; border-radius:11px; background:linear-gradient(135deg,#0a84ff,#64d2ff); color:#fff; display:grid; place-items:center; font-weight:700; box-shadow:var(--shadow)}
    .title{font-size:17px; font-weight:700}
    .sub{font-size:12px; color:var(--muted)}
      .brand-right{display:flex; align-items:center; gap:8px}
      .modeltag{font-size:11px;color:var(--muted);border:1px solid var(--border);padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.04)}
      :root[data-theme="light"] .modeltag{background:rgba(0,0,0,0.03)}
      .iconbtn{width:32px; height:32px; display:grid; place-items:center; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer}
      .iconbtn:active{transform:scale(0.97)}

    /* Chat */
    .chat{flex:1; padding:12px 14px; display:flex; flex-direction:column; gap:12px; overflow:auto; scroll-behavior:smooth}
    .bubble{max-width:86%; padding:12px 14px; border-radius:18px; border:1px solid var(--border); box-shadow:var(--shadow); white-space:pre-wrap; line-height:1.45; font-size:16px}
    .from-user{align-self:flex-end; background:var(--bubble-user)}
    .from-ai{align-self:flex-start; background:var(--bubble-ai)}

    /* Uploader — single big tile */
    .uploader{padding:14px}
    #uploadTile{display:grid; place-items:center; width:100%; height:220px; border:1px solid var(--border); border-radius:var(--radius-lg); background:linear-gradient(180deg, #0f172a, #0b1220); box-shadow:var(--shadow); cursor:pointer; user-select:none}
    #uploadTile:active{transform:scale(0.997)}
    .plus{display:flex; flex-direction:column; align-items:center; gap:10px; color:var(--muted)}
    .plus-icon{width:72px; height:72px; border-radius:22px; display:grid; place-items:center; background:#101a2e; border:1px solid var(--border)}
    .plus-icon svg{width:28px; height:28px; color:#cbd5ff}
    .plus-label{font-size:15px}
    .thumbWrap{width:100%; height:100%; overflow:hidden; border-radius:inherit}
    .thumbWrap img{width:100%; height:100%; object-fit:cover}

    /* Composer */
    .composer{position:sticky; bottom:0; z-index:15; padding:10px 12px 18px; background:linear-gradient(180deg, rgba(11,18,32,0), rgba(11,18,32,0.75) 30%, #0b1220)}
    .field{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end; border:1px solid var(--border); border-radius:26px; padding:10px 12px; background:var(--card); box-shadow:var(--shadow)}
    textarea{resize:none; min-height:72px; max-height:40vh; border:none; outline:none; font-size:18px; padding:8px 10px; width:100%; background:transparent; color:var(--text)}
    textarea::placeholder{color:#94a3b8}
    .send{appearance:none; border:none; outline:none; border-radius:999px; width:56px; height:56px; display:grid; place-items:center; font-weight:700; cursor:pointer; background:#0a84ff; color:white; box-shadow:0 10px 25px rgba(10,132,255,0.35)}
    .send:disabled{opacity:.6}

    /* Hint */
    .hint{font-size:12px; color:var(--muted); padding:0 16px 10px}

      /* Suggestions */
      .suggestions{display:flex; flex-wrap:wrap; gap:8px; padding:8px 14px 6px}
      .sugg{font-size:13px; color:var(--text); background:var(--card); border:1px solid var(--border); padding:8px 10px; border-radius:999px; cursor:pointer; box-shadow:var(--shadow)}
      .sugg:active{transform:scale(0.98)}
      .sugg-label{font-size:12px; color:var(--muted); padding:0 16px 6px}

    @media (min-width:768px){
      #uploadTile{height:260px}
      textarea{min-height:96px}
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <div class="top">
      <div class="brand">
        <div class="brand-left">
          <div class="mark" aria-hidden="true">SB</div>
          <div>
            <div class="title">Sehat Buddy</div>
            <div class="sub">Hinglish report chat • ⚠️ Emergency ho to turant doctor/ER</div>
          </div>
        </div>
        <div class="brand-right">
          <div class="modeltag" id="modelTag" title="Auto model selection">Model: gpt-5-mini • Effort: medium (auto)</div>
          <button class="iconbtn" id="newChatBtn" title="New chat" aria-label="New chat">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16M4 12h10M4 17h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button class="iconbtn" id="themeBtn" title="Toggle theme" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v2m0 14v2m7-9h2M3 12H1m14.95-6.95 1.41-1.41M6.64 17.36l-1.41 1.41m0-12.72L6.64 7.05M17.36 17.36l1.41 1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </div>

    <main class="chat" id="chat" aria-live="polite"></main>

    <div class="uploader">
      <div id="uploadTile" tabindex="0" role="button" aria-label="Tasveer jodo (ek hi image)">
        <div class="plus" id="plusState">
          <div class="plus-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
          <div class="plus-label">Tasveer jodo (jpg/png)</div>
        </div>
        <div class="thumbWrap" id="thumbWrap" hidden></div>
        <input type="file" id="file" accept="image/*" hidden />
      </div>
      <div class="hint">Sirf **ek** image add hogi. Zarurat ho to nayi image add karke purani replace ho jayegi.</div>
    </div>

    <div class="sugg-label" id="suggLabel" hidden>Smart suggestions</div>
    <div class="suggestions" id="suggestions"></div>

    <div class="composer">
      <div class="field">
        <textarea id="userInput" placeholder="Yahan likhiye… (jaise: ‘Yeh CBC report samjha do’)"></textarea>
        <button class="send" id="sendBtn" aria-label="Bhejo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="m4 12 7-7m-7 7 7 7m9-7H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="hint">Privacy: Yahan hum data store nahi karte. Par jawab ke liye OpenAI ko bhejna padta hai. Personal details share na karein. Yeh general info hai; final salah ke liye apne doctor se milen.</div>
    </div>
  </div>

  <script>
    // ====== Theme bootstrap before UI paints ======
    (function(){
      const saved = localStorage.getItem('sb_theme');
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      const mode = saved || (prefersLight ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', mode);
    })();

    // ====== Config: API key via base64url-encoded string (avoids plaintext in source) ======
    const ENCODED_KEY = 'c2stcHJvai00VTVtbW53VzdvSE85cVkwd29zd3c5dFJaYlRHRkttVFR1SFlWYmVoSTZKYTR5NXk0MEM4MS11Sk90bWphQmtfMWxSZnQ4Umw2SlQzQmxia0ZKd1o3RzEyVTM2Njl1UGlqUVZFanhQYVJUaVNwSlFUVTVlV2RjdWF2RDV4eUJzcTdhZXJydTJ0SnJ0RHZBTXlXWldrM3RKUEpZb0E=';
    function decodeBase64Url(encoded){
      try{
        const b64 = encoded.replace(/-/g,'+').replace(/_/g,'/').replace(/\s/g,'');
        const padLen = (4 - (b64.length % 4)) % 4;
        const b64p = b64 + '='.repeat(padLen);
        return atob(b64p);
      }catch{ return ''; }
    }
    let API_KEY = decodeBase64Url(ENCODED_KEY);

    // ====== Minimal Apple-like experience, all visible text in Hinglish ======
    const chat = document.getElementById('chat');
    const sendBtn = document.getElementById('sendBtn');
    const input = document.getElementById('userInput');
    const fileInput = document.getElementById('file');
    const uploadTile = document.getElementById('uploadTile');
    const plusState = document.getElementById('plusState');
    const thumbWrap = document.getElementById('thumbWrap');
    const modelTag = document.getElementById('modelTag');
    const themeBtn = document.getElementById('themeBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const suggestionsEl = document.getElementById('suggestions');
    const suggLabelEl = document.getElementById('suggLabel');

    const SYSTEM_PROMPT = `Aap *Sehat Buddy* hain — ek simple Hinglish health-report explainer Indian mom ke liye.\n\nSTYLE:\n- Seedhi, pyaari Hinglish. Bullet points. Emojis thode theek.\n- \u26a0\ufe0f Doctor nahi hain — diagnosis/medicine prescribe mat kariye.\n- Red flags par urgent care suggest kariye.\n\nINPUT: sirf image, sirf text, ya dono. Image aaye to OCR soch ke key points nikaaliye.\n\nMEDICINE/PRESCRIPTION ho to batayein: Name, Use, Common side effects, Serious side effects (red flags), How to take (generic), Interactions, Precautions, Missed dose tip, Storage, Doctor se puchhne layak sawaal.\n\nLAB/SCAN REPORT ho to batayein: Highlights (3–5), Test-wise notes (result vs reference, simple meaning), Possible reasons (non-diagnostic), Lifestyle tips, Doctor ke sawaal, Missing info, Next steps, Confidence. Agar image diya ho to 8–10 image-specific observations (date, lab name, initials only, units, ref ranges, arrows, specimen, method, comments, stamp/sign, legibility).\n\nFORMAT (Hinglish):\n- 1–2 line summary, phir headings: Report/Meds Name, Highlights, Side Effects, Test-wise Notes, Possible Reasons (non-diagnostic), Lifestyle Tips, Doctor se poochne layak sawaal, Missing info, Next steps, Confidence, Image-specific points.\n- Crisp 150–250 words jab tak zyada detail na maange.\n- Agar image unreadable ho to politely better photo maangein.\n- End line: \"Yeh general info hai. Apne doctor se confirm zaroor karein.\"`;

    let currentImageDataUrl = null; // data URL for single image
    const history = [];

    // Welcome
    addBubble('Namaste! 👋 Apna report photo ya text bhejiye. Main simple Hinglish mein samjhaunga/samjhaungi. (\u26a0\ufe0f Emergency mein turant doctor/ER.)', 'ai');

    // Upload interactions — single image
    uploadTile.addEventListener('click', ()=> fileInput.click());
    uploadTile.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); } });
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return; if(!f.type.startsWith('image/')){ alert('Image hi choose karein (jpg/png).'); return; }
      const dataUrl = await fileToDataURL(f);
      const resized = await resizeImageDataURL(dataUrl, 1600, 1600, 0.9);
      currentImageDataUrl = resized || dataUrl;
      renderThumb(currentImageDataUrl);
    });

    function renderThumb(dataUrl){
      plusState.hidden = true; thumbWrap.hidden = false; thumbWrap.innerHTML = `<img alt="aapki image" src="${dataUrl}"/>`;
    }

    // Send actions
    sendBtn.addEventListener('click', onSend);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSend(); } });

    // Theme toggle
    themeBtn.addEventListener('click', ()=>{
      const curr = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = curr === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('sb_theme', next);
    });

    // New chat
    newChatBtn.addEventListener('click', ()=>{
      clearChatAndState();
      generateInitialSuggestions();
    });

    // Suggestion click (event delegation)
    suggestionsEl.addEventListener('click', (e)=>{
      const target = e.target.closest('[data-suggestion]');
      if(!target) return;
      input.value = target.getAttribute('data-suggestion') || '';
      onSend();
    });

    async function onSend(){
      const text = input.value.trim();
      if(!text && !currentImageDataUrl){ alert('Kuch likhiye ya image add kijiye.'); return; }

      if(history.length === 0){ history.push({ role:'system', content:[{type:'input_text', text: SYSTEM_PROMPT}] }); }

      addBubble(text || '[Sirf image]', 'user', currentImageDataUrl);

      const hasImage = !!currentImageDataUrl;
      const route = await routeDecision(text, hasImage).catch(()=> fallbackHeuristic(text, hasImage));
      updateModelTag(route.model, route.effort);

      const userContent = [];
      if(text) userContent.push({ type:'input_text', text });
      if(currentImageDataUrl) userContent.push({ type:'input_image', image_url: currentImageDataUrl });
      history.push({ role:'user', content: userContent });

      input.value = '';
      currentImageDataUrl = null; plusState.hidden = false; thumbWrap.hidden = true; thumbWrap.innerHTML='';
      sendBtn.disabled = true;

      const aiBubble = addBubble('…', 'ai');
      try{
        const responseText = await streamToBubble({
          model: route.model,
          input: history,
          reasoning: { effort: route.effort },
          text: { verbosity: route.effort==='high' ? 'high' : 'medium' },
          stream: true,
          store: false
        }, API_KEY, aiBubble);
        // After each response, generate follow-up suggestions
        generateFollowupSuggestions(responseText, text);
      }catch(err){
        console.error(err);
        aiBubble.innerHTML = `<b style="color:#ff6b6b">Error:</b> ${escapeHtml(err.message||err)}`;
      }finally{ sendBtn.disabled = false; }
    }

    function updateModelTag(model, effort){
      modelTag.textContent = `Model: ${model} • Effort: ${effort} (auto)`;
    }

    // Auto model routing using gpt-5-mini (with safe fallback)
    async function routeDecision(text, hasImage){
      if(hasImage) return { model: 'gpt-5', effort: 'high' };
      const routerSystem = 'Aap ek router ho. Sirf JSON return karo jisme `model` ("gpt-5" ya "gpt-5-mini") aur `effort` ("low"|"medium"|"high") ho. Rule: agar kaam chota/hello/thanks jaisa hai to gpt-5-mini, effort low. Agar medical report/zyada detail/analysis chahiye to gpt-5, effort high. Beech me ho to gpt-5-mini, effort medium. Sirf JSON, aur kuch nahi.';
      const promptText = JSON.stringify({ text: (text||'').slice(0,2000), chars: (text||'').length, hasImage }, null, 2);
      const payload = {
        model: 'gpt-5-mini',
        input: [
          { role: 'system', content: [{ type:'input_text', text: routerSystem }]},
          { role: 'user', content: [{ type:'input_text', text: promptText }]}
        ],
        text: { verbosity: 'low' },
        stream: true,
        store: false
      };
      const txt = await readSSEText(payload, API_KEY);
      const match = txt.match(/\{[\s\S]*\}/);
      if(match){
        try{
          const obj = JSON.parse(match[0]);
          if((obj.model==='gpt-5'||obj.model==='gpt-5-mini') && (obj.effort==='low'||obj.effort==='medium'||obj.effort==='high')) return obj;
        }catch{}
      }
      return fallbackHeuristic(text, hasImage);
    }

    function fallbackHeuristic(text, hasImage){
      if(hasImage) return { model:'gpt-5', effort:'high' };
      const t = (text||'').toLowerCase();
      const len = t.length;
      const nums = (t.match(/\d+/g)||[]).length;
      const keywords = /(report|cbc|wbc|rbc|hb|hba1c|lipid|ldl|hdl|triglyceride|x-ray|xray|ecg|mri|ct|biopsy|scan|interpret|analysis|explain|reference|range|mg\/dl|mmol|mm\^3|platelet|bilirubin|creatinine|bun|sgot|sgpt)/i.test(t);
      if(keywords || len>240 || nums>=3) return { model:'gpt-5', effort:'high' };
      if(len<20) return { model:'gpt-5-mini', effort:'low' };
      return { model:'gpt-5-mini', effort:'medium' };
    }

    // Read Responses API stream and return plain text (no UI updates)
    async function readSSEText(payload, apiKey){
      const res = await fetch('https://api.openai.com/v1/responses', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` }, body: JSON.stringify(payload) });
      if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
      const reader = res.body.getReader(); const decoder = new TextDecoder('utf-8'); let fullText=''; let buf='';
      while(true){ const {done, value} = await reader.read(); if(done) break; buf += decoder.decode(value, {stream:true}); const parts = buf.split(/\r?\n/); buf = parts.pop() ?? ''; for(const l of parts){ if(!l.startsWith('data: ')) continue; const d=l.slice(6).trim(); if(d==='[DONE]') continue; try{ const e=JSON.parse(d); if(e.type==='response.output_text.delta' && typeof e.delta==='string'){ fullText+=e.delta; } else if(typeof e.output_text==='string'){ fullText+=e.output_text; } }catch{} } }
      return fullText;
    }

    // Chat bubble helper
    function addBubble(text, who='ai', imgUrl=null){
      const el = document.createElement('div');
      el.className = 'bubble ' + (who==='user' ? 'from-user' : 'from-ai');
      if(imgUrl){
        el.innerHTML = `${text ? escapeHtml(text) + '<br/>' : ''}<div style="margin-top:10px; border:1px solid var(--border); border-radius:16px; overflow:hidden; max-height:320px"><img alt="aapki image" src="${imgUrl}" style="display:block; width:100%; height:auto"/></div>`;
      } else {
        el.textContent = text;
      }
      chat.appendChild(el); chat.scrollTop = chat.scrollHeight; return el;
    }

    // Streaming to bubble via Responses API (robust SSE parsing with buffering)
    async function streamToBubble(payload, apiKey, bubbleEl){
      const res = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let fullText = '';
      let sseBuffer = '';

      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        sseBuffer += decoder.decode(value, {stream:true});
        const parts = sseBuffer.split(/\r?\n/);
        sseBuffer = parts.pop() ?? '';

        for(const line of parts){
          if(!line) continue;
          if(!line.startsWith('data: ')) continue;
          const data = line.slice(6).trim();
          if(data === '[DONE]') continue;
          try{
            const evt = JSON.parse(data);
            if(evt.type === 'response.output_text.delta' && typeof evt.delta === 'string'){
              fullText += evt.delta; bubbleEl.textContent = fullText; chat.scrollTop = chat.scrollHeight;
            } else if(evt.type === 'message.delta' && evt.delta?.content?.length){
              const piece = evt.delta.content.map(p=>p.text || '').join('');
              fullText += piece; bubbleEl.textContent = fullText; chat.scrollTop = chat.scrollHeight;
            } else if(typeof evt.output_text === 'string'){
              fullText += evt.output_text; bubbleEl.textContent = fullText; chat.scrollTop = chat.scrollHeight;
            }
          }catch(e){ /* Agar JSON half aya ho to next chunk me complete hoga */ }
        }
      }

      history.push({ role:'assistant', content:[{type:'output_text', text: fullText}] });
      return fullText;
    }

    // Utilities
    function fileToDataURL(file){
      return new Promise((resolve, reject)=>{ const r = new FileReader(); r.onload = ()=>resolve(r.result); r.onerror = reject; r.readAsDataURL(file); });
    }
    function resizeImageDataURL(src, maxW=1600, maxH=1600, quality=0.9){
      return new Promise((resolve)=>{ const img = new Image(); img.onload = ()=>{ let w=img.width, h=img.height; const ratio = Math.min(maxW/w, maxH/h, 1); const cw=Math.round(w*ratio), ch=Math.round(h*ratio); const c=document.createElement('canvas'); c.width=cw; c.height=ch; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch); const type = src.startsWith('data:image/png')? 'image/png':'image/jpeg'; resolve(c.toDataURL(type, quality)); }; img.onerror=()=>resolve(null); img.src=src; });
    }
    function escapeHtml(str){ return (str||'').replace(/[&<>\"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[s]); }

    function clearChatAndState(){
      chat.innerHTML = '';
      history.length = 0;
      currentImageDataUrl = null;
      plusState.hidden = false; thumbWrap.hidden = true; thumbWrap.innerHTML='';
      addBubble('Namaste! 👋 Apna report photo ya text bhejiye. Main simple Hinglish mein samjhaunga/samjhaungi. (⚠️ Emergency mein turant doctor/ER.)', 'ai');
      updateModelTag('gpt-5-mini','medium');
      renderSuggestions([], false);
    }

    // ====== Suggestions ======
    function renderSuggestions(items, showLabel=true){
      suggestionsEl.innerHTML = '';
      if(items && items.length){
        suggLabelEl.hidden = !showLabel;
        for(const s of items){
          const btn = document.createElement('button');
          btn.className = 'sugg';
          btn.type = 'button';
          btn.setAttribute('data-suggestion', s);
          btn.textContent = s;
          suggestionsEl.appendChild(btn);
        }
      } else {
        suggLabelEl.hidden = true;
      }
    }

    async function callJSONResponse(payload, apiKey){
      const res = await fetch('https://api.openai.com/v1/responses', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
      const data = await res.json();
      let txt = '';
      if(typeof data.output_text === 'string') txt = data.output_text;
      else if(Array.isArray(data.output)){
        // Fallback to concatenating any text parts
        try{ txt = data.output.map(o=> (o?.content||[]).map(c=>c.text||'').join('')).join(''); }catch{ txt=''; }
      }
      return txt;
    }

    function defaultStarterSuggestions(){
      return [
        'Mera CBC report simple words me samjha do',
        'Lipid profile me LDL high ka matlab kya hota hai?',
        'TSH/thyroid report ko explain karo',
        'Chest X-ray report ke highlights batao'
      ];
    }

    async function generateInitialSuggestions(){
      try{
        const sys = 'Aap ek assistant ho jo sirf JSON object return karta hai jisme key `suggestions` ho aur uski value 4 chhoti Hinglish prompts ki array ho. Prompts Sehat Buddy health-report chatbot ko start karne ke liye hon. Sirf valid JSON return karna.';
        const payload = {
          model: 'gpt-5-mini',
          input: [
            { role: 'system', content: [{ type:'input_text', text: sys }] },
            { role: 'user', content: [{ type:'input_text', text: 'Context: User Indian mom style, Hinglish. Give 4 diverse starters about lab reports, medicines, and imaging. 8-12 words each.' }] }
          ],
          reasoning: { effort: 'low' },
          text: { format: { type: 'json_object' }, verbosity: 'low' },
          stream: false,
          store: false
        };
        const txt = await callJSONResponse(payload, API_KEY);
        const obj = JSON.parse(txt);
        const items = Array.isArray(obj?.suggestions) ? obj.suggestions.slice(0,4) : defaultStarterSuggestions();
        renderSuggestions(items, true);
      }catch{
        renderSuggestions(defaultStarterSuggestions(), true);
      }
    }

    async function generateFollowupSuggestions(lastAssistantText, lastUserText){
      try{
        const sys = 'Return only JSON with key `suggestions` as array of 4 short Hinglish follow-up prompts. They should help continue the same medical-report conversation. Only valid JSON.';
        const user = JSON.stringify({
          lastAssistant: (lastAssistantText||'').slice(0, 1200),
          lastUser: (lastUserText||'').slice(0, 400)
        });
        const payload = {
          model: 'gpt-5-mini',
          input: [
            { role: 'system', content: [{ type:'input_text', text: sys }] },
            { role: 'user', content: [{ type:'input_text', text: user }] }
          ],
          text: { format: { type: 'json_object' }, verbosity: 'low' },
          stream: false,
          store: false
        };
        const txt = await callJSONResponse(payload, API_KEY);
        const obj = JSON.parse(txt);
        const items = Array.isArray(obj?.suggestions) ? obj.suggestions.slice(0,4) : [];
        if(items.length){ renderSuggestions(items, true); }
      }catch{
        // Keep previous suggestions if follow-up generation fails
      }
    }

    // ====== Lightweight hidden tests (console me) ======
    function runTests(){
      const results = [];
      const assert = (ok, name)=>{ (ok?console.log:console.error)(ok?`✅ ${name}`:`❌ ${name}`); results.push({name, ok}); };

      // Test 1: Regex split for CRLF/LF
      const t1 = 'data: x\n' + 'data: y\r\n' + 'data: z\n';
      const lines1 = t1.split(/\r?\n/).filter(Boolean);
      assert(lines1.length === 3 && lines1[0]==='data: x' && lines1[2]==='data: z', 'Split works for LF & CRLF');

      // Test 2: SSE buffering across chunks for response.output_text.delta
      let buf=''; let collected='';
      function feed(chunk){
        buf += chunk; const parts = buf.split(/\r?\n/); buf = parts.pop() ?? ''; for(const l of parts){ if(l.startsWith('data: ')){ const d=l.slice(6); try{const e=JSON.parse(d); if(e.type==='response.output_text.delta') collected+=e.delta;}catch{ /* ignore */ } } }
      }
      feed('data: {"type":"response.output_text.delta","delta":"He"}\n');
      feed('data: {"type":"response.output_text.delta","delta":"llo"}\n');
      feed('data: [DONE]\n');
      assert(collected==='Hello', 'Buffer handles split events');

      // Test 3: message.delta fallback
      buf=''; collected='';
      function feed2(chunk){ buf += chunk; const parts = buf.split(/\r?\n/); buf = parts.pop() ?? ''; for(const l of parts){ if(l.startsWith('data: ')){ const d=l.slice(6); try{const e=JSON.parse(d); if(e.type==='message.delta' && e.delta?.content?.length){ collected += e.delta.content.map(p=>p.text||'').join(''); }}catch{} } } }
      feed2('data: {"type":"message.delta","delta":{"content":[{"type":"output_text","text":"Hi"}]}}\n');
      feed2('data: {"type":"message.delta","delta":{"content":[{"type":"output_text","text":"!"}]}}\n');
      assert(collected==='Hi!', 'Fallback handles message.delta');

      // Test 4: heuristic — greeting -> mini/low
      const h1 = fallbackHeuristic('hi', false);
      assert(h1.model==='gpt-5-mini' && h1.effort==='low', 'Heuristic: greeting uses mini/low');

      // Test 5: heuristic — long medical -> gpt-5/high
      const medicalText = 'Please explain my lipid profile: LDL 165 mg/dL, HDL 38 mg/dL, Triglycerides 260 mg/dL, total cholesterol 260 mg/dL, reference ranges, reasons, lifestyle.';
      const h2 = fallbackHeuristic(medicalText, false);
      assert(h2.model==='gpt-5' && h2.effort==='high', 'Heuristic: medical analysis uses gpt-5/high');

      // Test 6: heuristic — image present -> gpt-5/high
      const h3 = fallbackHeuristic('anything', true);
      assert(h3.model==='gpt-5' && h3.effort==='high', 'Heuristic: image => gpt-5/high');

      const allOk = results.every(r=>r.ok);
      console.log(allOk? '✅ All tests passed' : '❌ Some tests failed');
    }
    window.addEventListener('load', runTests);
    window.addEventListener('load', generateInitialSuggestions);
  </script>
</body>
</html>
